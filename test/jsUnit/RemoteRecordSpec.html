<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="../../dist/scripts/lib/jquery-2.0.3.js"></script>
    <script src="vendor/mocha.js"></script>
    <script src="vendor/sinon.js"></script>
    <script src="vendor/require.js"></script>
    <script src="config.js"></script>

</head>
<body>
<!--PLACEHOLDER FOR MOCHA TEST RESULTS-->
<div id="mocha"></div>

<!--FIXTURE HTML FOR TESTS-->
<div id="spec-markup">
    <div id="eventId" class="remote-record" data-channel-id="4053" data-event-id="218"></div>
    <div id="startTime" class="remote-record" data-channel-id="4053" data-start-time="1369845598"></div>
    <div id="noStartTime" class="remote-record" data-channel-id="4053"></div>
    <div id="noChannelId" class="remote-record" data-start-time="4053"></div>
    <div id="dummy">This is a dummy div</div>
</div>

</div>
<script>
    globalskycom = {
        browserSupport: {
            isMobile: function() {
                return false;
            }
        }
    };
</script>

<!--TEST-->
<script>
    require(['modules/remoterecord', '../../test/jsUnit/setup'], function(hash) {
        function stubEpgCall(stub, url, expectedData) {
            stub.withArgs({url: url + '?jsonp=jqueryCallback&callback=?', dataType: 'jsonp', async: false, jsonpCallback: 'jqueryCallback'})
                    .returns(responseSuccess(expectedData));
        }

        function responseSuccess(data) {
            var d = $.Deferred();
            d.resolve(data);
            return d.promise();
        }

        describe('Remote Record Buttons', function() {
            beforeEach(function() {
                // Initialise smoax and register the matchers
                chai.use(smoax.setup());
                ajaxStub = sinon.stub($, "ajax");
            });

            afterEach(function() {
                // Revert $.ajax to a real ajax implementation
                smoax.release();
                ajaxStub.reset();
            });

            it('generates a remote record button', function() {
                $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                expect($('#eventId').children('.remote-record').length).to.equal(1);
            });

            it('will generate only one button if remote record called several times', function() {
                for (var i = 0; i < 5; i++) {
                    $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                    expect($('#eventId').children('.remote-record').length).to.equal(1);
                }
            });

            it('renders an invalid error when button has missing attributes', function() {
                $('#noStartTime').skycom_remoterecord();
                $('#noChannelId').skycom_remoterecord();

                expect($('#noStartTime').html()).to.equal('required attributes data-channel-id or data-event-id / data-start-time not found');
                expect($('#noChannelId').html()).to.equal('required attributes data-channel-id or data-event-id / data-start-time not found');
            });

            it('gets epg details when channel id and start time is provided', function() {
                stubEpgCall(ajaxStub, '/stub/prog/json/lookup/4053/1369845598', {'status': 200, 'body': {'eid': 218}});
                stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {'rr': 'S'}});
                stubEpgCall(ajaxStub, '/stub/rractivation/json/serieslinkenabled', {'status': 200, 'body': {}});

                $('#startTime').skycom_remoterecord({epgServicesUrl: '/stub/'});
                $('#startTime .remote-record').click();

                expect($('.remote-record .popover.active').length).to.equal(1);
            });

            it('when the item is not a series link, records the programme', function() {
                stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {"rr": 'R'}});
                stubEpgCall(ajaxStub, '/stub/prog/json/rr/4053/218', {'status': 200, 'body': {"rr": 0}});
                expect($('#eventId').children('.remote-record .recorded').length).to.equal(0);

                $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                $('#eventId .remote-record').click();

                expect($('#eventId').children('.remote-record .recorded').length).to.equal(1);
            });

            describe('record from popover menu', function() {

                beforeEach(function() {
                    stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {"rr": 'S'}});
                    stubEpgCall(ajaxStub, '/stub/rractivation/json/serieslinkenabled', {'status': 200, 'body': {}});

                    $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                    $('#eventId .remote-record').click();
                });

                it('record once', function() {
                    stubEpgCall(ajaxStub, '/stub/prog/json/rr/4053/218', {'status': 200, 'body': {"rr": 0}});

                    $('#eventId .record-once').click();

                    expect($('#eventId').children('.remote-record .recorded').length).to.equal(1);
                    expect($('#eventId').children('.remote-record .series').length).to.equal(0);
                });

                it('record series', function() {
                    stubEpgCall(ajaxStub, '/stub/prog/json/rr/4053/218?sl=true', {'status': 200, 'body': {"rr": 0}});

                    var p = $('#eventId .record-series').click();

                    expect($('#eventId').children('.remote-record .recorded').length).to.equal(1);
                    expect($('#eventId').children('.remote-record .series').length).to.equal(1);
                });

            });

            describe('redirects to sky id', function() {

                it('from remote record or non-series programme', function() {
                    stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {"rr": 'S'}});
                    stubEpgCall(ajaxStub, '/stub/rractivation/json/serieslinkenabled', {'status': 401, 'body': {}});

                    var remoteRecordButton = $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/', skyIdUrl: window.location.href + '#redirectUrl'});
                    var originalLocation = window.location.href;

                    $('#eventId .remote-record').click();

                    expect(window.location.href).to.have.string('#redirectUrl?successUrl=' + encodeURIComponent(originalLocation));
                });

                it('from remote record activation check for series link', function() {
                    stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {"rr": 'R'}});
                    stubEpgCall(ajaxStub, '/stub/prog/json/rr/4053/218', {'status': 401, 'body': {}});

                    var remoteRecordButton = $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/', skyIdUrl: window.location.href + '#redirectUrl'});
                    var originalLocation = window.location.href;

                    $('#eventId .remote-record').click();

                    expect(window.location.href).to.have.string('#redirectUrl?successUrl=' + encodeURIComponent(originalLocation));
                });

                it('only if error is 401', function(){
                    stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {"rr": 'R'}});
                    stubEpgCall(ajaxStub, '/stub/prog/json/rr/4053/218', {'status': 404, 'body': {}});

                    $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/', skyIdUrl: window.location.href + '#redirectUrl'});
                    $('#eventId .remote-record').click();

                    expect(window.location.href).to.equal(window.location.href);
                    expect($('#eventId').text()).to.equal('Unable to make remote record request');
                });
            });


            describe('displays popover properly', function() {
                beforeEach(function(){
                    stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {"rr": 'S'}});
                    stubEpgCall(ajaxStub, '/stub/rractivation/json/serieslinkenabled', {'status': 200, 'body': {}});

                    $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                    $('#eventId .remote-record').click();
                });

                it('only creates popover once');
                it('can hide popover');
            });

            describe('displays errors properly', function() {
                var errorCodes = [ 1, 2, 3, 4, 5 , 6, 7, 8, 9, 10, 55 ];
                var errorMessages = [
                    "Programme not found",
                    "Programme has already started",
                    "You are not logged in",
                    "You are not a Sky subscriber",
                    "You do not have Sky+",
                    "You are not signed up for remote record",
                    "This programme is not available in your region",
                    "Internal error",
                    "Unable to determine Sky+ box due to multiple viewing cards",
                    "Unable to record pay-per-view broadcast",
                    "Unable to make remote record request"
                ];

                for (var x = 0; x < errorCodes.length; x++) {
                    var errorCode = errorCodes[x];
                    var errorMessage = errorMessages[x];

                    it('code ' + errorCode + ' returns error ' + errorMessage, function() {
                        stubEpgCall(ajaxStub, '/stub/prog/json/serieslinkinfo/4053/218', {'status': 200, 'body': {"rr": 'R'}});
                        stubEpgCall(ajaxStub, '/stub/prog/json/rr/4053/218', {'status': 200, 'body': {"rr": errorCode}});
                        expect($('#eventId').children('.remote-record .recorded').length).to.equal(0);

                        $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                        $('#eventId .remote-record').click();

                        expect($('#eventId').html()).to.equal(errorMessage);
                    });
                }
            });
        });

        mocha.run();
    });
</script>

</body>
</html>