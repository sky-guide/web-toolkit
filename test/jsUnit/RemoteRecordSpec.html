<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="../../dist/scripts/lib/jquery-2.0.3.js"></script>
    <script src="vendor/mocha.js"></script>
    <script src="vendor/require.js"></script>
    <script src="config.js"></script>

</head>
<body>
<!--PLACEHOLDER FOR MOCHA TEST RESULTS-->
<div id="mocha"></div>

<!--FIXTURE HTML FOR TESTS-->
<div id="spec-markup">
    <div id="eventId" class="remote-record" data-channel-id="4053" data-event-id="218"></div>
    <div id="startTime" class="remote-record" data-channel-id="4053" data-start-time="1369845598"></div>
    <div id="noStartTime" class="remote-record" data-channel-id="4053"></div>
    <div id="noChannelId" class="remote-record" data-start-time="4053"></div>
    <div id="dummy">This is a dummy div</div>
</div>

</div>
<script>
    globalskycom = {
        browserSupport: {
            isMobile: function() {
                return false;
            }
        }
    };
</script>

<!--TEST-->
<script>
    require(['modules/remoterecord', '../../test/jsUnit/setup'], function(hash) {

        describe('Remote Record Buttons', function() {

            beforeEach(function() {
                // Initialise smoax and register the matchers
                chai.use(smoax.setup());
            });

            afterEach(function() {
                // Revert $.ajax to a real ajax implementation
                smoax.release();
            });

            it('generates a remote record button', function() {
                $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                expect($('#eventId').children('.remote-record').length).to.equal(1);
            });

            it('will generate only one button if remote record called several times', function() {
                for (var i = 0; i < 5; i++) {
                    $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                    expect($('#eventId').children('.remote-record').length).to.equal(1);
                }
            });

            it('renders an invalid error when button has missing attributes', function() {
                $('#noStartTime').skycom_remoterecord();
                $('#noChannelId').skycom_remoterecord();

                expect($('#noStartTime').html()).to.equal('required attributes data-channel-id or data-event-id / data-start-time not found');
                expect($('#noChannelId').html()).to.equal('required attributes data-channel-id or data-event-id / data-start-time not found');
            });

            it('gets epg details when channel id and start time is provided', function() {
                smoax.register('GET', '/stub/prog/json/lookup/4053/1369845598', {"eid": 218});
                smoax.register('GET', '/stub/prog/json/serieslinkinfo/4053/218', {"rr": "S"});
                smoax.register('GET', '/stub/rractivation/json/serieslinkenabled', {});

                $('#startTime').skycom_remoterecord({epgServicesUrl: '/stub/'});
                $('#startTime .remote-record').click();

                expect(smoax).to.have.beenInvokedWith('get', '/stub/prog/json/lookup/4053/1369845598');
                expect(smoax).to.have.beenInvokedWith('get', '/stub/prog/json/serieslinkinfo/4053/218');

            });

            it('when the item is not a series link, records the programme', function() {
                smoax.register('GET', '/stub/prog/json/serieslinkinfo/4053/218', {"rr": 'R'});
                smoax.register('GET', '/stub/prog/json/rr/4053/218', {"rr": 0})
                expect($('#eventId').children('.remote-record .recorded').length).to.equal(0);

                $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                $('#eventId .remote-record').click();

                expect(smoax).to.have.beenInvokedWith('get', '/stub/prog/json/rr/4053/218');
                expect($('#eventId').children('.remote-record .recorded').length).to.equal(1);
            });

            describe('record from popover menu', function() {

                beforeEach(function() {
                    smoax.register('GET', '/stub/prog/json/serieslinkinfo/4053/218', {"rr": 'S'});
                    smoax.register('GET', '/stub/rractivation/json/serieslinkenabled', {});

                    $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                    $('#eventId .remote-record').click();
                });

                it('series information is checked', function() {
                    expect(smoax).to.have.beenInvokedWith('get', '/stub/prog/json/serieslinkinfo/4053/218');
                    expect(smoax).to.have.beenInvokedWith('get', '/stub/rractivation/json/serieslinkenabled');
                });

                it('record once', function() {
                    smoax.register('GET', '/stub/prog/json/rr/4053/218', {"rr": 0})

                    $('#eventId .record-once').click();

                    expect($('#eventId').children('.remote-record .recorded').length).to.equal(1);
                    expect($('#eventId').children('.remote-record .series').length).to.equal(0);
                    expect(smoax).to.have.beenInvokedWith('get', '/stub/prog/json/rr/4053/218');
                });

                it('record series', function() {
                    smoax.register('GET', '/stub/prog/json/rr/4053/218?sl=true', {"rr": 0})

                    var p = $('#eventId .record-series').click();

                    expect($('#eventId').children('.remote-record .recorded').length).to.equal(1);
                    expect($('#eventId').children('.remote-record .series').length).to.equal(1);
                    expect(smoax).to.have.beenInvokedWith('get', '/stub/prog/json/rr/4053/218?sl=true');
                });

            });

            describe('redirects to sky id', function() {

                it('from remote record or non-series programme', function() {
                    smoax.register('GET', '/stub/prog/json/serieslinkinfo/4053/218', {"rr": "S"});
                    smoax.registerError('GET', '/stub/rractivation/json/serieslinkenabled', 401, 'Not Authorized');

                    var remoteRecordButton = $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/', skyIdUrl: window.location.href + '#redirectUrl'});
                    var originalLocation = window.location.href;

                    $('#eventId .remote-record').click();

                    expect(window.location.href).to.have.string('#redirectUrl?successUrl=' + encodeURIComponent(originalLocation));
                });

                it('from remote record activation check for series link', function() {
                    smoax.register('GET', '/stub/prog/json/serieslinkinfo/4053/218', {"rr": "R"});
                    smoax.registerError('GET', '/stub/prog/json/rr/4053/218', 401, 'Not Authorized');

                    var remoteRecordButton = $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/', skyIdUrl: window.location.href + '#redirectUrl'});
                    var originalLocation = window.location.href;

                    $('#eventId .remote-record').click();

                    expect(window.location.href).to.have.string('#redirectUrl?successUrl=' + encodeURIComponent(originalLocation));
                });

                it('only redirects to sky id if error is 401', function(){

                });
            });


            describe('displays popover properly', function() {

                beforeEach(function(){
                    smoax.register('GET', '/stub/prog/json/serieslinkinfo/4053/218', {"rr": 'S'});
                    smoax.register('GET', '/stub/rractivation/json/serieslinkenabled', {});

                    $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                    $('#eventId .remote-record').click();
                });

                it('only creates popover once', function() {
                });

                it('can hide popover', function() {
                });
            });

            describe('displays errors properly', function() {
                var errorCodes = [ 1, 2, 3, 4, 5 , 6, 7, 8, 9, 10, 55 ];
                var errorMessages = [
                    "Programme not found",
                    "Programme has already started",
                    "You are not logged in",
                    "You are not a Sky subscriber",
                    "You do not have Sky+",
                    "You are not signed up for remote record",
                    "This programme is not available in your region",
                    "Internal error",
                    "Unable to determine Sky+ box due to multiple viewing cards",
                    "Unable to record pay-per-view broadcast",
                    "Unable to make remote record request"
                ];

                for (var x = 0; x < errorCodes.length; x++) {
                    var errorCode = errorCodes[x];
                    var errorMessage = errorMessages[x];

                    it('code ' + errorCode + ' returns error ' + errorMessage, function() {
                        smoax.register('GET', '/stub/prog/json/serieslinkinfo/4053/218', {"rr": 'R'});
                        smoax.register('GET', '/stub/prog/json/rr/4053/218', {"rr": errorCode})
                        expect($('#eventId').children('.remote-record .recorded').length).to.equal(0);

                        $('#eventId').skycom_remoterecord({epgServicesUrl: '/stub/'});
                        $('#eventId .remote-record').click();

                        expect(smoax).to.have.beenInvokedWith('get', '/stub/prog/json/rr/4053/218');
                        expect($('#eventId').html()).to.equal(errorMessage);
                    });
                }
            });
        });

        mocha.run();
    });
</script>

</body>
</html>